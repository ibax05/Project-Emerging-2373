{"version":3,"names":["_webexCore","require","_uuid","_interopRequireDefault","Support","WebexPlugin","extend","namespace","getFeedbackUrl","options","request","method","api","resource","body","_defaults2","default","appVersion","config","appType","feedbackId","uuid","v4","languageCode","then","res","url","getSupportUrl","webex","qs","submitLogs","metadata","logs","_this","metadataArray","_constructFileMetadata","logger","sdkBuffer","clientBuffer","buffer","formatLogs","filename","locusId","callStart","concat","sessionId","userId","credentials","getUserToken","catch","getClientToken","_ref","_asyncToGenerator2","_regenerator","mark","_callee","token","headers","initalOpts","finalOpts","wrap","_callee$","_context","prev","next","authorization","toString","service","file","shouldAttemptReauth","phases","initialize","upload","$uri","session","tempURL","finalize","$body","logFilename","data","internal","device","abrupt","stop","_x","apply","arguments","map","key","value","filter","entry","Boolean","push","orgId","version","_default","exports"],"sources":["support.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {WebexPlugin} from '@webex/webex-core';\nimport {defaults} from 'lodash';\nimport uuid from 'uuid';\n\nconst Support = WebexPlugin.extend({\n  namespace: 'Support',\n\n  getFeedbackUrl(options) {\n    options = options || {};\n\n    return this.request({\n      method: 'POST',\n      api: 'conversation',\n      resource: 'users/deskFeedbackUrl',\n      body: defaults(options, {\n        appVersion: this.config.appVersion,\n        appType: this.config.appType,\n        feedbackId: options.feedbackId || uuid.v4(),\n        languageCode: this.config.languageCode,\n      }),\n    }).then((res) => res.body.url);\n  },\n\n  getSupportUrl() {\n    return this.webex\n      .request({\n        method: 'GET',\n        api: 'conversation',\n        resource: 'users/deskSupportUrl',\n        qs: {\n          languageCode: this.config.languageCode,\n        },\n      })\n      .then((res) => res.body.url);\n  },\n\n  submitLogs(metadata, logs) {\n    const metadataArray = this._constructFileMetadata(metadata);\n\n    // this is really testing that Ampersand is fully ready.  once it's ready, these exist\n    if (\n      !logs &&\n      this.webex.logger.sdkBuffer &&\n      this.webex.logger.clientBuffer &&\n      this.webex.logger.buffer\n    ) {\n      logs = this.webex.logger.formatLogs();\n    }\n\n    let filename;\n\n    if (metadata.locusId && metadata.callStart) {\n      filename = `${metadata.locusId}_${metadata.callStart}.txt`;\n    } else {\n      filename = `${this.webex.sessionId}.txt`;\n    }\n\n    let userId;\n\n    return this.webex.credentials\n      .getUserToken()\n      .catch(() => this.webex.credentials.getClientToken())\n      .then(async (token) => {\n        const headers = {authorization: token.toString()};\n\n        const initalOpts = {\n          service: 'clientLogs',\n          resource: 'logs/urls',\n        };\n\n        const finalOpts = {\n          service: 'clientLogs',\n          resource: 'logs/meta',\n        };\n\n        const options = defaults(initalOpts, {\n          file: logs,\n          shouldAttemptReauth: false,\n          headers,\n          phases: {\n            initialize: {\n              body: {\n                file: filename,\n              },\n            },\n            upload: {\n              $uri: (session) => session.tempURL,\n            },\n            finalize: defaults(finalOpts, {\n              $body: (session) => {\n                userId = session.userId;\n\n                return {\n                  filename: session.logFilename,\n                  data: metadataArray,\n                  userId: this.webex.internal.device.userId || session.userId,\n                };\n              },\n            }),\n          },\n        });\n\n        return this.webex.upload(options);\n      })\n      .then((body) => {\n        if (userId && !body.userId) {\n          body.userId = userId;\n        }\n\n        return body;\n      });\n  },\n\n  /**\n   * Constructs an array of key-value pairs for log upload.\n   * @param {*} metadata\n   * @returns {array}\n   */\n  _constructFileMetadata(metadata) {\n    const metadataArray = [\n      'locusId',\n      'callStart',\n      'feedbackId',\n      'correlationId',\n      'meetingId',\n      'surveySessionId',\n    ]\n      .map((key) => {\n        if (metadata[key]) {\n          return {\n            key,\n            value: metadata[key],\n          };\n        }\n\n        return null;\n      })\n      .filter((entry) => Boolean(entry));\n\n    if (this.webex.sessionId) {\n      metadataArray.push({\n        key: 'trackingId',\n        value: this.webex.sessionId,\n      });\n    }\n\n    if (this.webex.internal.device.userId) {\n      metadataArray.push({\n        key: 'userId',\n        value: this.webex.internal.device.userId,\n      });\n    }\n\n    if (this.webex.internal.device.orgId) {\n      metadataArray.push({\n        key: 'orgId',\n        value: this.webex.internal.device.orgId,\n      });\n    }\n\n    return metadataArray;\n  },\n});\n\nexport default Support;\n"],"mappings":"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"}