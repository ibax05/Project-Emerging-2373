{"version":3,"names":["assert","require","_","retry","_require","createTestUser","removeTestUser","createWhistlerTestUser","removeWhistlerTestUser","allUsers","after","timeout","forEach","user","webex","internal","mercury","disconnect","_remove","_create","options","_options","count","promises","i","push","makeUser","_promise","default","all","config","defaults","scopes","process","env","WEBEX_SCOPE","whistler","then","users","map","_ref","_asyncToGenerator2","_regenerator","mark","_callee","wrap","_callee$","_context","prev","next","reservationUrl","catch","reason","console","warn","token","authorization","_deleteProperty","abrupt","resolve","setTimeout","stop","_x","apply","arguments","module","exports","create","WEBEX_CLIENT_ID","WEBEX_CLIENT_SECRET","remove"],"sources":["index.js"],"sourcesContent":["/* eslint-disable no-underscore-dangle */\n/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\n/* eslint-env mocha */\n/* eslint camelcase: [0] */\n\nconst assert = require('assert');\n\nconst _ = require('lodash');\nconst retry = require('@webex/test-helper-retry');\nconst {\n  createTestUser,\n  removeTestUser,\n  createWhistlerTestUser,\n  removeWhistlerTestUser,\n} = require('@webex/test-users');\n\nconst allUsers = [];\n\nif (after) {\n  after(function () {\n    /* eslint no-invalid-this: [0] */\n    this.timeout(120000);\n    allUsers.forEach(\n      (user) =>\n        user.webex && user.webex.internal.mercury && user.webex.internal.mercury.disconnect()\n    );\n\n    return _remove(allUsers);\n  });\n}\n\n/**\n * Helper\n * @param {Object} options\n * @param {number} options.count amount of users to create\n * @param {boolean} options.whistler use Whistler Service to generate test users\n * @param {Object} options.config configuration to pass to test-users library\n * see test-users package for full options\n * @private\n * @returns {Promise<Array<User>>}\n */\nfunction _create(options) {\n  options = options || {};\n  let {count} = options;\n\n  if (!count) {\n    count = 1;\n  }\n\n  const promises = [];\n\n  for (let i = 0; i < count; i += 1) {\n    promises.push(retry(makeUser));\n  }\n\n  return Promise.all(promises);\n\n  /**\n   * Helper\n   * @private\n   * @returns {Promise<User>}\n   */\n  function makeUser() {\n    const config = _.defaults(\n      {\n        scopes: process.env.WEBEX_SCOPE,\n      },\n      options.config\n    );\n\n    return options.whistler\n      ? createWhistlerTestUser(config).then((user) => {\n          allUsers.push(user);\n\n          return user;\n        })\n      : createTestUser(config).then((user) => {\n          allUsers.push(user);\n\n          return user;\n        });\n  }\n}\n\n/**\n * Helper\n * @param {Array<User>} users\n * @returns {Promise}\n */\nfunction _remove(users) {\n  return Promise.all(\n    users.map(async (user) => {\n      // Check if user was created using whistler\n      if (user.reservationUrl) {\n        await removeWhistlerTestUser(user).catch((reason) => {\n          console.warn('failed to delete test user', reason);\n        });\n      } else {\n        if (user.token && !user.token.authorization) {\n          Reflect.deleteProperty(user, 'token');\n        }\n\n        await removeTestUser(user).catch((reason) => {\n          console.warn('failed to delete test user', reason);\n        });\n      }\n\n      // Edge times out waiting for the delete calls to complete (and test user\n      // deletion isn't really something we need to wait for anyway) so we'll just\n      // give enough time for the requests to go out, then allow the browser to\n      // close, even if the requests haven't returned.\n      return new Promise((resolve) => {\n        setTimeout(resolve, 500);\n      });\n    })\n  );\n}\n\nmodule.exports = {\n  create: (options) => {\n    assert(process.env.WEBEX_CLIENT_ID, 'WEBEX_CLIENT_ID must be defined');\n    assert(process.env.WEBEX_CLIENT_SECRET, 'WEBEX_CLIENT_SECRET must be defined');\n\n    return _create(options);\n  },\n  remove: _remove,\n};\n"],"mappings":"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"}