{"version":3,"names":["_gm","_interopRequireDefault","require","processImage","_ref","file","type","thumbnailMaxWidth","thumbnailMaxHeight","enableThumbnails","logger","fileType","startsWith","_promise","default","resolve","fileDimensions","reject","gm","size","err","_pick2","thumbnail","thumbnailDimensions","resize","autoOrient","toBuffer","buffer","then","all","catch","errorString","toString","includes","warn","debug"],"sources":["process-image.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport gm from 'gm';\nimport {pick} from 'lodash';\n\n/**\n * Measures an image file and produces a thumbnail for it\n * @param {Object} options\n * @param {Blob|ArrayBuffer} options.file\n * @param {Number} options.thumbnailMaxWidth\n * @param {Number} options.thumbnailMaxHeight\n * @param {Boolean} options.enableThumbnails\n * @param {Object} options.logger\n * @returns {Promise<Array>} Buffer, Dimensions, thumbnailDimensions\n */\nexport default function processImage({\n  file,\n  type,\n  thumbnailMaxWidth,\n  thumbnailMaxHeight,\n  enableThumbnails,\n  logger,\n}) {\n  const fileType = type || file.type;\n\n  if (!fileType || !fileType.startsWith('image')) {\n    return Promise.resolve();\n  }\n\n  const fileDimensions = new Promise((resolve, reject) => {\n    gm(file).size((err, size) => {\n      if (err) {\n        reject(err);\n\n        return;\n      }\n\n      resolve(pick(size, 'width', 'height'));\n    });\n  });\n\n  let thumbnail;\n  let thumbnailDimensions;\n\n  if (enableThumbnails) {\n    thumbnail = new Promise((resolve, reject) => {\n      gm(file)\n        .resize(thumbnailMaxWidth, thumbnailMaxHeight)\n        .autoOrient()\n        .toBuffer('PNG', (err, buffer) => {\n          if (err) {\n            reject(err);\n\n            return;\n          }\n\n          resolve(buffer);\n        });\n    });\n\n    thumbnailDimensions = thumbnail.then(\n      (buffer) =>\n        new Promise((resolve, reject) => {\n          gm(buffer).size((err, size) => {\n            if (err) {\n              reject(err);\n\n              return;\n            }\n\n            resolve(pick(size, 'width', 'height'));\n          });\n        })\n    );\n  }\n\n  return Promise.all([thumbnail, fileDimensions, thumbnailDimensions]).catch((err) => {\n    const errorString = err.toString();\n\n    if (errorString.includes('EPIPE')) {\n      logger.warn(err, 'Is GraphicsMagick installed?');\n\n      return Promise.resolve();\n    }\n\n    if (errorString.includes('No decode delegate for this image format')) {\n      logger.debug(err, 'File does not appear to be an image');\n\n      return Promise.resolve();\n    }\n\n    if (errorString.includes('Stream yields empty buffer')) {\n      logger.debug(err, 'File does not appear to be an image');\n\n      return Promise.resolve();\n    }\n\n    return Promise.reject(err);\n  });\n}\n"],"mappings":"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"}