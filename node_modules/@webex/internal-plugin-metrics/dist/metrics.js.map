{"version":3,"names":["_webexCore","require","_common","_config","_batcher","_interopRequireDefault","_clientMetricsBatcher","_callDiagnosticEventsBatcher","ownKeys","object","enumerableOnly","keys","_Object$keys","_Object$getOwnPropertySymbols","symbols","filter","sym","_Object$getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","Object","forEach","key","_defineProperty2","default","_Object$getOwnPropertyDescriptors","_Object$defineProperties","_Object$defineProperty","_BrowserDetection","BrowserDetection","getOSName","getOSVersion","getBrowserName","getBrowserVersion","getOSNameInternal","_OSMap$getOSName","OSMap","OS_NAME","OTHERS","getSparkUserAgent","webex","_webex$config","_ref","config","appName","appVersion","appPlatform","sparkUserAgent","CLIENT_NAME","concat","Metrics","WebexPlugin","extend","children","batcher","Batcher","clientMetricsBatcher","ClientMetricsBatcher","callDiagnosticEventsBatcher","CallDiagnosticEventsBatcher","namespace","submit","value","request","submitClientMetrics","eventName","props","undefined","preLoginId","Error","payload","metricName","tags","browser","os","domain","window","location","hostname","fields","browser_version","os_version","sdk_version","version","platform","spark_user_agent","client_id","credentials","type","metrics","context","app","locale","name","eventPayload","timestamp","Date","valueOf","_payload","postPreLoginMetric","aliasUser","method","api","resource","headers","body","qs","alias","_this","getClientToken","then","token","authorization","toString","submitCallDiagnosticEvents","event","_default","exports"],"sources":["metrics.js"],"sourcesContent":["/* eslint-disable default-param-last */\n\n/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {WebexPlugin} from '@webex/webex-core';\nimport {BrowserDetection} from '@webex/common';\nimport {OS_NAME, OSMap, CLIENT_NAME} from './config';\n\nimport Batcher from './batcher';\nimport ClientMetricsBatcher from './client-metrics-batcher';\nimport CallDiagnosticEventsBatcher from './call-diagnostic-events-batcher';\n\nconst {getOSName, getOSVersion, getBrowserName, getBrowserVersion} = BrowserDetection();\n\nexport function getOSNameInternal() {\n  return OSMap[getOSName()] ?? OS_NAME.OTHERS;\n}\n\nfunction getSparkUserAgent(webex) {\n  const {appName, appVersion, appPlatform} = webex?.config ?? {};\n\n  let sparkUserAgent = CLIENT_NAME;\n\n  if (appName) {\n    sparkUserAgent += ` ${appName}/${appVersion ?? '0.0'}`;\n  }\n\n  if (appPlatform) {\n    sparkUserAgent += ` ${appPlatform}`;\n  }\n\n  return sparkUserAgent;\n}\n\nconst Metrics = WebexPlugin.extend({\n  children: {\n    batcher: Batcher,\n    clientMetricsBatcher: ClientMetricsBatcher,\n    callDiagnosticEventsBatcher: CallDiagnosticEventsBatcher,\n  },\n\n  namespace: 'Metrics',\n\n  submit(key, value) {\n    return this.batcher.request({key, ...value});\n  },\n\n  /**\n   * This corresponds to #sendSemiStructured() in the deprecated metrics handler\n   * @param {string} eventName\n   * @param {Object} props\n   * @param {string} preLoginId\n   * @returns {Object} HttpResponse object\n   */\n  submitClientMetrics(eventName, props = {}, preLoginId) {\n    if (!eventName) {\n      throw Error('Missing behavioral metric name. Please provide one');\n    }\n    const payload = {metricName: eventName};\n\n    payload.tags = {\n      ...props.tags,\n      browser: getBrowserName(),\n      os: getOSNameInternal(),\n\n      // Node does not like this so we need to check if it exists or not\n      // eslint-disable-next-line no-undef\n      domain:\n        typeof window !== 'undefined' ? window.location.hostname || 'non-browser' : 'non-browser', // Check what else we could measure\n    };\n\n    payload.fields = {\n      ...props.fields,\n      browser_version: getBrowserVersion(),\n      os_version: getOSVersion(),\n      sdk_version: this.webex.version,\n      platform: 'Web',\n      spark_user_agent: getSparkUserAgent(this.webex),\n      client_id: this.webex.credentials.config.client_id,\n    };\n\n    payload.type = props.type || this.webex.config.metrics.type;\n\n    payload.context = {\n      ...props.context,\n      app: {\n        version: this.webex.version,\n      },\n      locale: 'en-US',\n      os: {\n        name: getOSNameInternal(),\n        version: getOSVersion(),\n      },\n    };\n\n    if (props.eventPayload) {\n      payload.eventPayload = props.eventPayload;\n    }\n\n    // Mocking the time in tests when running in node\n    // is impossible so unable to use Date.now()\n    payload.timestamp = new Date().valueOf();\n\n    if (preLoginId) {\n      const _payload = {\n        metrics: [payload],\n      };\n\n      // Do not batch these because pre-login events occur during onboarding, so we will be partially blind\n      // to users' progress through the reg flow if we wait to persist pre-login metrics for people who drop off because\n      // their metrics will not post from a queue flush in time\n      return this.postPreLoginMetric(_payload, preLoginId);\n    }\n\n    return this.clientMetricsBatcher.request(payload);\n  },\n\n  /**\n   * Issue request to alias a user's pre-login ID with their CI UUID\n   * @param {string} preLoginId\n   * @returns {Object} HttpResponse object\n   */\n  aliasUser(preLoginId) {\n    return this.request({\n      method: 'POST',\n      api: 'metrics',\n      resource: 'clientmetrics',\n      headers: {\n        'x-prelogin-userid': preLoginId,\n      },\n      body: {},\n      qs: {\n        alias: true,\n      },\n    });\n  },\n\n  postPreLoginMetric(payload, preLoginId) {\n    return this.webex.credentials.getClientToken().then((token) =>\n      this.request({\n        method: 'POST',\n        api: 'metrics',\n        resource: 'clientmetrics-prelogin',\n        headers: {\n          authorization: token.toString(),\n          'x-prelogin-userid': preLoginId,\n        },\n        body: payload,\n      })\n    );\n  },\n\n  submitCallDiagnosticEvents(payload) {\n    const event = {\n      type: 'diagnostic-event',\n      eventPayload: payload,\n    };\n\n    return this.callDiagnosticEventsBatcher.request(event);\n  },\n});\n\nexport default Metrics;\n"],"mappings":"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"}