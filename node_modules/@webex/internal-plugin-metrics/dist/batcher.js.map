{"version":3,"names":["_webexCore","require","_commonTimers","sym","_symbol","default","MetricsBatcher","Batcher","extend","namespace","prepareItem","item","env","process","NODE_ENV","appType","config","time","_now","version","webex","_promise","resolve","prepareRequest","queue","map","postTime","submitHttpRequest","payload","request","method","service","resource","body","metrics","handleHttpSuccess","res","_this","all","options","acceptItem","handleHttpError","reason","_this2","WebexHttpError","NetworkOrCORSError","logger","warn","delay","nextDelay","batcherRetryPlateau","safeSetTimeout","rerequest","_apply","prototype","_this3","getDeferredForRequest","then","_ref","_ref2","_slicedToArray2","defer","req","enqueue","bounce","catch","reject","fingerprintRequest","fingerprintResponse","_default","exports"],"sources":["batcher.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {Batcher, WebexHttpError} from '@webex/webex-core';\nimport {safeSetTimeout} from '@webex/common-timers';\n\nconst sym = Symbol('metric id');\n\nconst MetricsBatcher = Batcher.extend({\n  namespace: 'Metrics',\n\n  prepareItem(item) {\n    // Keep non-prod data out of metrics\n    const env = process.env.NODE_ENV === 'production' ? null : 'TEST';\n\n    item.appType = item.appType || this.config.appType;\n    item.env = item.env || env;\n    item.time = item.time || Date.now();\n    item.version = item.version || this.webex.version;\n\n    return Promise.resolve(item);\n  },\n\n  prepareRequest(queue) {\n    return Promise.resolve(\n      queue.map((item) => {\n        item.postTime = item.postTime || Date.now();\n\n        return item;\n      })\n    );\n  },\n\n  submitHttpRequest(payload) {\n    return this.webex.request({\n      method: 'POST',\n      service: 'metrics',\n      resource: 'metrics',\n      body: {\n        metrics: payload,\n      },\n    });\n  },\n\n  handleHttpSuccess(res) {\n    return Promise.all(res.options.body.metrics.map((item) => this.acceptItem(item)));\n  },\n\n  handleHttpError(reason) {\n    if (reason instanceof WebexHttpError.NetworkOrCORSError) {\n      this.logger.warn(\n        'metrics-batcher: received network error submitting metrics, reenqueuing payload'\n      );\n\n      return Promise.all(\n        reason.options.body.metrics.map(\n          (item) =>\n            new Promise((resolve) => {\n              const delay = item[sym].nextDelay;\n\n              if (delay < this.config.batcherRetryPlateau) {\n                item[sym].nextDelay *= 2;\n              }\n              safeSetTimeout(() => {\n                resolve(this.rerequest(item));\n              }, delay);\n            })\n        )\n      );\n    }\n\n    return Reflect.apply(Batcher.prototype.handleHttpError, this, [reason]);\n  },\n\n  rerequest(item) {\n    return Promise.all([this.getDeferredForRequest(item), this.prepareItem(item)]).then(\n      ([defer, req]) => {\n        this.enqueue(req)\n          .then(() => this.bounce())\n          .catch((reason) => defer.reject(reason));\n      }\n    );\n  },\n\n  fingerprintRequest(item) {\n    item[sym] = item[sym] || {\n      nextDelay: 1000,\n    };\n\n    return Promise.resolve(item[sym]);\n  },\n\n  fingerprintResponse(item) {\n    return Promise.resolve(item[sym]);\n  },\n});\n\nexport default MetricsBatcher;\n"],"mappings":"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"}