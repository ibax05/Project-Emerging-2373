{"version":3,"names":["_events","require","_common","_commonTimers","_uuid","_interopRequireDefault","_errors","_createSuper","Derived","hasNativeReflectConstruct","_isNativeReflectConstruct","_createSuperInternal","Super","_getPrototypeOf2","default","result","NewTarget","constructor","_Reflect$construct","arguments","apply","_possibleConstructorReturn2","Reflect","sham","Proxy","Boolean","prototype","valueOf","call","e","sockets","_weakMap","Socket","_EventEmitter","_inherits2","_super","_this","_classCallCheck2","onmessage","bind","_assertThisInitialized2","onclose","_createClass2","key","get","binaryType","bufferedAmount","extensions","protocol","readyState","url","value","close","options","_this2","_promise","resolve","reject","socket","logger","info","code","Error","_defaults2","reason","closeTimer","safeSetTimeout","error","warn","forceCloseDelay","event","clearTimeout","open","_this3","checkRequired","_keys","forEach","_defineProperty","enumerable","WebSocket","getWebSocketConstructor","_fixCloseCode","UnknownResponse","BadRequest","NotAuthorized","Forbidden","ConnectionError","onopen","_authorize","then","catch","onerror","set","pongTimer","pingTimer","emit","removeAllListeners","data","JSON","parse","sequenceNumber","_parseInt2","debug","expectedSequenceNumber","concat","processedEvent","_acknowledge","type","send","_this4","_isObject2","_stringify","_has2","messageId","id","_this5","uuid","v4","token","trackingId","logLevelToken","waitForBufferState","eventType","removeListener","_ping","once","toLowerCase","_this6","confirmPongId","onPongNotReceived","scheduleNextPingAndCancelPongTimer","pingInterval","pongTimeout","EventEmitter","exports"],"sources":["socket-base.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {EventEmitter} from 'events';\n\nimport {checkRequired} from '@webex/common';\nimport {safeSetTimeout} from '@webex/common-timers';\nimport {defaults, has, isObject} from 'lodash';\nimport uuid from 'uuid';\n\nimport {\n  BadRequest,\n  ConnectionError,\n  Forbidden,\n  NotAuthorized,\n  UnknownResponse,\n  // NotFound\n} from '../errors';\n\nconst sockets = new WeakMap();\n\n/**\n * Generalized socket abstraction\n */\nexport default class Socket extends EventEmitter {\n  /**\n   * constructor\n   * @returns {Socket}\n   */\n  constructor() {\n    super();\n    this.onmessage = this.onmessage.bind(this);\n    this.onclose = this.onclose.bind(this);\n  }\n\n  /**\n   * @see https://developer.mozilla.org/en-US/docs/Web/API/WebSocket\n   * @returns {string}\n   */\n  get binaryType() {\n    return sockets.get(this).binaryType;\n  }\n\n  /**\n   * @see https://developer.mozilla.org/en-US/docs/Web/API/WebSocket\n   * @returns {number}\n   */\n  get bufferedAmount() {\n    return sockets.get(this).bufferedAmount;\n  }\n\n  /**\n   * @see https://developer.mozilla.org/en-US/docs/Web/API/WebSocket\n   * @returns {string}\n   */\n  get extensions() {\n    return sockets.get(this).extensions;\n  }\n\n  /**\n   * @see https://developer.mozilla.org/en-US/docs/Web/API/WebSocket\n   * @returns {string}\n   */\n  get protocol() {\n    return sockets.get(this).protocol;\n  }\n\n  /**\n   * @see https://developer.mozilla.org/en-US/docs/Web/API/WebSocket\n   * @returns {number}\n   */\n  get readyState() {\n    return sockets.get(this).readyState;\n  }\n\n  /**\n   * @see https://developer.mozilla.org/en-US/docs/Web/API/WebSocket\n   * @returns {string}\n   */\n  get url() {\n    return sockets.get(this).url;\n  }\n\n  /**\n   * Provides the environmentally appropriate constructor (ws in NodeJS,\n   * WebSocket in browsers)\n   * @returns {WebSocket}\n   */\n  static getWebSocketConstructor() {\n    throw new Error(\n      'Socket.getWebSocketConstructor() must be implemented in an environmentally appropriate way'\n    );\n  }\n\n  /**\n   * Closes the socket\n   * @param {Object} options\n   * @param {string} options.reason\n   * @param {number} options.code\n   * @returns {Promise}\n   */\n  close(options) {\n    return new Promise((resolve, reject) => {\n      const socket = sockets.get(this);\n\n      if (!socket) {\n        // Open has not been called yet so there is no socket to close\n        resolve();\n\n        return;\n      }\n      // logger is defined once open is called\n      this.logger.info('socket: closing');\n\n      if (socket.readyState === 2 || socket.readyState === 3) {\n        this.logger.info('socket: already closed');\n        resolve();\n\n        return;\n      }\n\n      options = options || {};\n      if (options.code && options.code !== 1000 && (options.code < 3000 || options.code > 4999)) {\n        reject(new Error('`options.code` must be 1000 or between 3000 and 4999 (inclusive)'));\n\n        return;\n      }\n\n      options = defaults(options, {\n        code: 1000,\n        reason: 'Done',\n      });\n\n      const closeTimer = safeSetTimeout(() => {\n        try {\n          this.logger.info('socket: no close event received, forcing closure');\n          resolve(\n            this.onclose({\n              code: 1000,\n              reason: 'Done (forced)',\n            })\n          );\n        } catch (error) {\n          this.logger.warn('socket: force-close failed', error);\n        }\n      }, this.forceCloseDelay);\n\n      socket.onclose = (event) => {\n        this.logger.info('socket: close event fired', event.code, event.reason);\n        clearTimeout(closeTimer);\n        this.onclose(event);\n        resolve(event);\n      };\n\n      socket.close(options.code, options.reason);\n    });\n  }\n\n  /**\n   * Opens a WebSocket\n   * @param {string} url\n   * @param {options} options\n   * @param {number} options.forceCloseDelay (required)\n   * @param {number} options.pingInterval (required)\n   * @param {number} options.pongTimeout (required)\n   * @param {string} options.token (required)\n   * @param {string} options.trackingId (required)\n   * @param {Logger} options.logger (required)\n   * @param {string} options.logLevelToken\n   * @returns {Promise}\n   */\n  open(url, options) {\n    return new Promise((resolve, reject) => {\n      /* eslint complexity: [0] */\n      if (!url) {\n        reject(new Error('`url` is required'));\n\n        return;\n      }\n\n      if (sockets.get(this)) {\n        reject(new Error('Socket#open() can only be called once per instance'));\n\n        return;\n      }\n\n      options = options || {};\n\n      checkRequired(\n        ['forceCloseDelay', 'pingInterval', 'pongTimeout', 'token', 'trackingId', 'logger'],\n        options\n      );\n\n      Object.keys(options).forEach((key) => {\n        Reflect.defineProperty(this, key, {\n          enumerable: false,\n          value: options[key],\n        });\n      });\n\n      const WebSocket = Socket.getWebSocketConstructor();\n\n      this.logger.info('socket: creating WebSocket');\n      const socket = new WebSocket(url, [], options);\n\n      socket.binaryType = 'arraybuffer';\n      socket.onmessage = this.onmessage;\n\n      socket.onclose = (event) => {\n        event = this._fixCloseCode(event);\n        this.logger.info('socket: closed before open', event.code, event.reason);\n        switch (event.code) {\n          case 1005:\n            // IE 11 doesn't seem to allow 4XXX codes, so if we get a 1005, assume\n            // it's a bad websocket url. That'll trigger a device refresh; if it\n            // turns out we had a bad token, the device refresh should 401 and\n            // trigger a token refresh.\n            return reject(new UnknownResponse(event));\n          case 4400:\n            return reject(new BadRequest(event));\n          case 4401:\n            return reject(new NotAuthorized(event));\n          case 4403:\n            return reject(new Forbidden(event));\n          // case 4404:\n          //   return reject(new NotFound(event));\n          default:\n            return reject(new ConnectionError(event));\n        }\n      };\n\n      socket.onopen = () => {\n        this.logger.info('socket: connected');\n        this._authorize()\n          .then(() => {\n            this.logger.info('socket: authorized');\n            socket.onclose = this.onclose;\n            resolve();\n          })\n          .catch(reject);\n      };\n\n      socket.onerror = (event) => {\n        this.logger.warn('socket: error event fired', event);\n      };\n\n      sockets.set(this, socket);\n      this.logger.info('socket: waiting for server');\n    });\n  }\n\n  /**\n   * Handles incoming CloseEvents\n   * @param {CloseEvent} event\n   * @returns {undefined}\n   */\n  onclose(event) {\n    this.logger.info('socket: closed', event.code, event.reason);\n    clearTimeout(this.pongTimer);\n    clearTimeout(this.pingTimer);\n\n    event = this._fixCloseCode(event);\n    this.emit('close', event);\n\n    // Remove all listeners to (a) avoid reacting to late pongs and (b) ensure\n    // we don't have a retain cycle.\n    this.removeAllListeners();\n  }\n\n  /**\n   * Handles incoming message events\n   * @param {MessageEvent} event\n   * @returns {undefined}\n   */\n  onmessage(event) {\n    try {\n      const data = JSON.parse(event.data);\n      const sequenceNumber = parseInt(data.sequenceNumber, 10);\n\n      this.logger.debug('socket: sequence number: ', sequenceNumber);\n      if (this.expectedSequenceNumber && sequenceNumber !== this.expectedSequenceNumber) {\n        this.logger.debug(\n          `socket: sequence number mismatch indicates lost mercury message. expected: ${this.expectedSequenceNumber}, actual: ${sequenceNumber}`\n        );\n        this.emit('sequence-mismatch', sequenceNumber, this.expectedSequenceNumber);\n      }\n      this.expectedSequenceNumber = sequenceNumber + 1;\n\n      // Yes, it's a little weird looking; we want to emit message events that\n      // look like normal socket message events, but event.data cannot be\n      // modified and we don't actually care about anything but the data property\n      const processedEvent = {data};\n\n      this._acknowledge(processedEvent);\n      if (data.type === 'pong') {\n        this.emit('pong', processedEvent);\n      } else {\n        this.emit('message', processedEvent);\n      }\n    } catch (error) {\n      // The above code should only be able to throw if we receive an unparsable\n      // message from Mercury. At this time, the only action we have is to\n      // ignore it and move on.\n      /* istanbul ignore next */\n      this.logger.warn('socket: error while receiving WebSocket message', error);\n    }\n  }\n\n  /**\n   * Sends a message up the socket\n   * @param {mixed} data\n   * @returns {Promise}\n   */\n  send(data) {\n    return new Promise((resolve, reject) => {\n      if (this.readyState !== 1) {\n        return reject(new Error('INVALID_STATE_ERROR'));\n      }\n\n      if (isObject(data)) {\n        data = JSON.stringify(data);\n      }\n\n      const socket = sockets.get(this);\n\n      socket.send(data);\n\n      return resolve();\n    });\n  }\n\n  /**\n   * Sends an acknowledgment for a specific event\n   * @param {MessageEvent} event\n   * @returns {Promise}\n   */\n  _acknowledge(event) {\n    if (!event) {\n      return Promise.reject(new Error('`event` is required'));\n    }\n\n    if (!has(event, 'data.id')) {\n      return Promise.reject(new Error('`event.data.id` is required'));\n    }\n\n    return this.send({\n      messageId: event.data.id,\n      type: 'ack',\n    });\n  }\n\n  /**\n   * Sends an auth message up the socket\n   * @private\n   * @returns {Promise}\n   */\n  _authorize() {\n    return new Promise((resolve) => {\n      this.logger.info('socket: authorizing');\n      this.send({\n        id: uuid.v4(),\n        type: 'authorization',\n        data: {\n          token: this.token,\n        },\n        trackingId: this.trackingId,\n        logLevelToken: this.logLevelToken,\n      });\n\n      const waitForBufferState = (event) => {\n        if (\n          !event.data.type &&\n          (event.data.data.eventType === 'mercury.buffer_state' ||\n            event.data.data.eventType === 'mercury.registration_status')\n        ) {\n          this.removeListener('message', waitForBufferState);\n          this._ping();\n          resolve();\n        }\n      };\n\n      this.once('message', waitForBufferState);\n    });\n  }\n\n  /**\n   * Deals with the fact that some browsers drop some close codes (but not\n   * close reasons).\n   * @param {CloseEvent} event\n   * @private\n   * @returns {CloseEvent}\n   */\n  _fixCloseCode(event) {\n    if (event.code === 1005 && event.reason) {\n      switch (event.reason.toLowerCase()) {\n        case 'replaced':\n          this.logger.info('socket: fixing CloseEvent code for reason: ', event.reason);\n          event.code = 4000;\n          break;\n        case 'authentication failed':\n        case 'authentication did not happen within the timeout window of 30000 seconds.':\n          this.logger.info('socket: fixing CloseEvent code for reason: ', event.reason);\n          event.code = 1008;\n          break;\n        default:\n        // do nothing\n      }\n    }\n\n    return event;\n  }\n\n  /**\n   * Sends a ping up the socket and confirms we get it back\n   * @param {[type]} id\n   * @private\n   * @returns {[type]}\n   */\n  _ping(id) {\n    const confirmPongId = (event) => {\n      try {\n        this.logger.debug('socket: pong', event.data.id);\n        if (event.data && event.data.id !== id) {\n          this.logger.info('socket: received pong for wrong ping id, closing socket');\n          this.logger.debug('socket: expected', id, 'received', event.data.id);\n          this.close({\n            code: 1000,\n            reason: 'Pong mismatch',\n          });\n        }\n      } catch (error) {\n        // This try/catch block was added as a debugging step; to the best of my\n        // knowledge, the above can never throw.\n        /* istanbul ignore next */\n        this.logger.error('socket: error occurred in confirmPongId', error);\n      }\n    };\n\n    const onPongNotReceived = () => {\n      try {\n        this.logger.info('socket: pong not receive in expected period, closing socket');\n        this.close({\n          code: 1000,\n          reason: 'Pong not received',\n        }).catch((reason) => {\n          this.logger.warn('socket: failed to close socket after missed pong', reason);\n        });\n      } catch (error) {\n        // This try/catch block was added as a debugging step; to the best of my\n        // knowledge, the above can never throw.\n        /* istanbul ignore next */\n        this.logger.error('socket: error occurred in onPongNotReceived', error);\n      }\n    };\n\n    const scheduleNextPingAndCancelPongTimer = () => {\n      try {\n        clearTimeout(this.pongTimer);\n        this.pingTimer = safeSetTimeout(() => this._ping(), this.pingInterval);\n      } catch (error) {\n        // This try/catch block was added as a debugging step; to the best of my\n        // knowledge, the above can never throw.\n        /* istanbul ignore next */\n        this.logger.error('socket: error occurred in scheduleNextPingAndCancelPongTimer', error);\n      }\n    };\n\n    id = id || uuid.v4();\n    this.pongTimer = safeSetTimeout(onPongNotReceived, this.pongTimeout);\n    this.once('pong', scheduleNextPingAndCancelPongTimer);\n    this.once('pong', confirmPongId);\n\n    this.logger.debug(`socket: ping ${id}`);\n\n    return this.send({\n      id,\n      type: 'ping',\n    });\n  }\n}\n"],"mappings":"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"}