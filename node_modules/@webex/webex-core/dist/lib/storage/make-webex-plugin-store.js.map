{"version":3,"names":["_common","require","_errors","defers","_weakMap","default","serialize","value","_isObject2","serialized","_keys","forEach","key","val","_isArray2","length","undefined","map","k","empty","reduce","acc","makeWebexPluginStorage","type","context","_dec","_class","WebexPluginStorage","oneFlight","keyFactory","concat","_classCallCheck2","set","_map","_createClass2","clear","webex","del","getNamespace","_context$webex","_len","arguments","args","Array","_key","apply","get","defer","Defer","then","res","resolve","put","waitFor","logger","debug","promise","initValue","parent","_result2","catch","reason","NotFoundError","process","env","NODE_ENV","toString","includes","warn","reject","_applyDecoratedDescriptor2","prototype","_getOwnPropertyDescriptor"],"sources":["make-webex-plugin-store.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {Defer, oneFlight} from '@webex/common';\nimport {isArray, isObject, result} from 'lodash';\n\nimport {NotFoundError} from './errors';\n\nconst defers = new WeakMap();\n\n/**\n * Walks an object before writing it to the store and omits empty arrays\n * @private\n * @param {Object} value\n * @returns {Object}\n */\nfunction serialize(value) {\n  if (!isObject(value)) {\n    return value;\n  }\n\n  const serialized = value.serialize ? value.serialize() : value;\n\n  Object.keys(serialized).forEach((key) => {\n    const val = serialized[key];\n\n    if (isArray(val)) {\n      if (val.length === 0) {\n        serialized[key] = undefined;\n      } else {\n        serialized[key] = val.map(serialize);\n      }\n    } else if (isObject(val)) {\n      Object.keys(val).forEach((k) => {\n        val[k] = serialize(val[k]);\n      });\n    }\n  });\n\n  const empty = Object.keys(serialized).reduce((acc, key) => acc && !serialized[key], true);\n\n  if (empty) {\n    return undefined;\n  }\n\n  return serialized;\n}\n\n/**\n * [makeWebexPluginStorage description]\n * @param {[type]} type\n * @param {[type]} context\n * @private\n * @returns {[type]}\n */\nexport default function makeWebexPluginStorage(type, context) {\n  /**\n   * Interface between WebexPlugin and Webex#boundeStorage or\n   * Webex#unboundedStorage\n   */\n  class WebexPluginStorage {\n    /**\n     * @param {Object} attrs\n     * @param {Object} options\n     * @returns {WebexPluginStorage}\n     */\n    constructor() {\n      defers.set(this, new Map());\n    }\n\n    /**\n     * Clears an entire namespace\n     * @returns {Promise}\n     */\n    clear() {\n      return context.webex[`${type}Storage`].del(context.getNamespace());\n    }\n\n    /**\n     * Deletes the specified key from the store\n     * @param {string} key\n     * @returns {[type]}\n     */\n    del(...args) {\n      return context.webex[`${type}Storage`].del(context.getNamespace(), ...args);\n    }\n\n    /**\n     * Retrieves the value specified by key from the store. Rejects with\n     * NotFoundError if no value can be found\n     * @param {string} key\n     * @returns {Promise}\n     */\n    get(key) {\n      let defer = defers.get(this).get(key);\n\n      if (!defer) {\n        defer = new Defer();\n        defers.get(this).set(key, defer);\n      }\n\n      return context.webex[`${type}Storage`].get(context.getNamespace(), key).then((res) => {\n        defer.resolve();\n\n        return res;\n      });\n    }\n\n    /**\n     * Writes a value to the store\n     * @param {string} key\n     * @param {any} value\n     * @returns {Promise}\n     */\n    put(key, value) {\n      return context.webex[`${type}Storage`].put(context.getNamespace(), key, serialize(value));\n    }\n\n    /**\n     * Returns a Promise that won't resolve until the value specified by key has\n     * been attempted to be loaded from the store. This allows us to lazily\n     * prevent certain method from executing until the specified keys have been\n     * retrieved from the store.\n     * @param {string} key\n     * @returns {Promise}\n     */\n    waitFor(key) {\n      context.logger.debug(\n        `plugin-storage(${context.getNamespace()}): waiting to init key \\`${key}\\``\n      );\n      const defer = defers.get(this).get(key);\n\n      if (defer) {\n        context.logger.debug(\n          `plugin-storage(${context.getNamespace()}): already inited \\`${key}\\``\n        );\n\n        return defer.promise;\n      }\n\n      context.logger.debug(`plugin-storage(${context.getNamespace()}): initing \\`${key}\\``);\n\n      return this.initValue(key);\n    }\n\n    @oneFlight({keyFactory: (key) => `initValue-${key}`})\n    /**\n     * Attempts to load the specified key from the store and set it on the parent\n     * object.\n     * @param {string} key\n     * @returns {Promise} Resolves (but not with the retrieved value) when\n     * the value retrieval complete\n     */\n    // suppress doc warning because decorators confuse eslint\n    // eslint-disable-next-line require-jsdoc\n    initValue(key) {\n      const defer = new Defer();\n\n      defers.get(this).set(key, defer);\n\n      // Intentionally bypasses this.get so we don't resolve the promise until\n      // after the parent value is set.\n      context.webex[`${type}Storage`]\n        .get(context.getNamespace(), key)\n        .then((value) => {\n          context.logger.debug(\n            `plugin-storage(${context.getNamespace()}): got \\`${key}\\` for first time`\n          );\n          if (key === '@') {\n            context.parent.set(value);\n          } else if (result(context[key], 'isState')) {\n            context[key].set(value);\n          } else {\n            context.set(key, value);\n          }\n          context.logger.debug(\n            `plugin-storage(${context.getNamespace()}): set \\`${key}\\` for first time`\n          );\n          defer.resolve();\n          context.logger.debug(`plugin-storage(${context.getNamespace()}): inited \\`${key}\\``);\n        })\n        .catch((reason) => {\n          // The  next conditional is a bit of an unfortunate solution to deal\n          // with circular dependencies in unit tests. It should not effect\n          // integration tests or production code.\n          if (\n            reason instanceof NotFoundError ||\n            (process.env.NODE_ENV !== 'production' &&\n              reason.toString().includes('MockNotFoundError'))\n          ) {\n            context.logger.debug(\n              `plugin-storage(${context.getNamespace()}): no data for \\`${key}\\`, continuing`\n            );\n\n            return defer.resolve();\n          }\n          context.logger.warn(\n            `plugin-storage(${context.getNamespace()}): failed to init \\`${key}\\``,\n            reason\n          );\n\n          return defer.reject(reason);\n        });\n\n      return defer.promise;\n    }\n  }\n\n  return new WebexPluginStorage();\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAIA,IAAAA,OAAA,GAAAC,OAAA;AAGA,IAAAC,OAAA,GAAAD,OAAA;AAPA;AACA;AACA;;AAOA,IAAME,MAAM,GAAG,IAAAC,QAAA,CAAAC,OAAA,EAAa;;AAE5B;AACA;AACA;AACA;AACA;AACA;AACA,SAASC,SAASA,CAACC,KAAK,EAAE;EACxB,IAAI,CAAC,IAAAC,UAAA,CAAAH,OAAA,EAASE,KAAK,CAAC,EAAE;IACpB,OAAOA,KAAK;EACd;EAEA,IAAME,UAAU,GAAGF,KAAK,CAACD,SAAS,GAAGC,KAAK,CAACD,SAAS,EAAE,GAAGC,KAAK;EAE9D,IAAAG,KAAA,CAAAL,OAAA,EAAYI,UAAU,CAAC,CAACE,OAAO,CAAC,UAACC,GAAG,EAAK;IACvC,IAAMC,GAAG,GAAGJ,UAAU,CAACG,GAAG,CAAC;IAE3B,IAAI,IAAAE,SAAA,CAAAT,OAAA,EAAQQ,GAAG,CAAC,EAAE;MAChB,IAAIA,GAAG,CAACE,MAAM,KAAK,CAAC,EAAE;QACpBN,UAAU,CAACG,GAAG,CAAC,GAAGI,SAAS;MAC7B,CAAC,MAAM;QACLP,UAAU,CAACG,GAAG,CAAC,GAAGC,GAAG,CAACI,GAAG,CAACX,SAAS,CAAC;MACtC;IACF,CAAC,MAAM,IAAI,IAAAE,UAAA,CAAAH,OAAA,EAASQ,GAAG,CAAC,EAAE;MACxB,IAAAH,KAAA,CAAAL,OAAA,EAAYQ,GAAG,CAAC,CAACF,OAAO,CAAC,UAACO,CAAC,EAAK;QAC9BL,GAAG,CAACK,CAAC,CAAC,GAAGZ,SAAS,CAACO,GAAG,CAACK,CAAC,CAAC,CAAC;MAC5B,CAAC,CAAC;IACJ;EACF,CAAC,CAAC;EAEF,IAAMC,KAAK,GAAG,IAAAT,KAAA,CAAAL,OAAA,EAAYI,UAAU,CAAC,CAACW,MAAM,CAAC,UAACC,GAAG,EAAET,GAAG;IAAA,OAAKS,GAAG,IAAI,CAACZ,UAAU,CAACG,GAAG,CAAC;EAAA,GAAE,IAAI,CAAC;EAEzF,IAAIO,KAAK,EAAE;IACT,OAAOH,SAAS;EAClB;EAEA,OAAOP,UAAU;AACnB;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACe,SAASa,sBAAsBA,CAACC,IAAI,EAAEC,OAAO,EAAE;EAAA,IAAAC,IAAA,EAAAC,MAAA;EAC5D;AACF;AACA;AACA;EAHE,IAIMC,kBAAkB,IAAAF,IAAA,GAqFrB,IAAAG,iBAAS,EAAC;IAACC,UAAU,EAAE,SAAAA,WAACjB,GAAG;MAAA,oBAAAkB,MAAA,CAAkBlB,GAAG;IAAA;EAAE,CAAC,CAAC,GAAAc,MAAA;IApFrD;AACJ;AACA;AACA;AACA;IACI,SAAAC,mBAAA,EAAc;MAAA,IAAAI,gBAAA,CAAA1B,OAAA,QAAAsB,kBAAA;MACZxB,MAAM,CAAC6B,GAAG,CAAC,IAAI,EAAE,IAAAC,IAAA,CAAA5B,OAAA,EAAS,CAAC;IAC7B;;IAEA;AACJ;AACA;AACA;IAHI,IAAA6B,aAAA,CAAA7B,OAAA,EAAAsB,kBAAA;MAAAf,GAAA;MAAAL,KAAA,EAIA,SAAA4B,MAAA,EAAQ;QACN,OAAOX,OAAO,CAACY,KAAK,IAAAN,MAAA,CAAIP,IAAI,aAAU,CAACc,GAAG,CAACb,OAAO,CAACc,YAAY,EAAE,CAAC;MACpE;;MAEA;AACJ;AACA;AACA;AACA;IAJI;MAAA1B,GAAA;MAAAL,KAAA,EAKA,SAAA8B,IAAA,EAAa;QAAA,IAAAE,cAAA;QAAA,SAAAC,IAAA,GAAAC,SAAA,CAAA1B,MAAA,EAAN2B,IAAI,OAAAC,KAAA,CAAAH,IAAA,GAAAI,IAAA,MAAAA,IAAA,GAAAJ,IAAA,EAAAI,IAAA;UAAJF,IAAI,CAAAE,IAAA,IAAAH,SAAA,CAAAG,IAAA;QAAA;QACT,OAAO,CAAAL,cAAA,GAAAf,OAAO,CAACY,KAAK,IAAAN,MAAA,CAAIP,IAAI,aAAU,EAACc,GAAG,CAAAQ,KAAA,CAAAN,cAAA,GAACf,OAAO,CAACc,YAAY,EAAE,EAAAR,MAAA,CAAKY,IAAI,EAAC;MAC7E;;MAEA;AACJ;AACA;AACA;AACA;AACA;IALI;MAAA9B,GAAA;MAAAL,KAAA,EAMA,SAAAuC,IAAIlC,GAAG,EAAE;QACP,IAAImC,KAAK,GAAG5C,MAAM,CAAC2C,GAAG,CAAC,IAAI,CAAC,CAACA,GAAG,CAAClC,GAAG,CAAC;QAErC,IAAI,CAACmC,KAAK,EAAE;UACVA,KAAK,GAAG,IAAIC,aAAK,EAAE;UACnB7C,MAAM,CAAC2C,GAAG,CAAC,IAAI,CAAC,CAACd,GAAG,CAACpB,GAAG,EAAEmC,KAAK,CAAC;QAClC;QAEA,OAAOvB,OAAO,CAACY,KAAK,IAAAN,MAAA,CAAIP,IAAI,aAAU,CAACuB,GAAG,CAACtB,OAAO,CAACc,YAAY,EAAE,EAAE1B,GAAG,CAAC,CAACqC,IAAI,CAAC,UAACC,GAAG,EAAK;UACpFH,KAAK,CAACI,OAAO,EAAE;UAEf,OAAOD,GAAG;QACZ,CAAC,CAAC;MACJ;;MAEA;AACJ;AACA;AACA;AACA;AACA;IALI;MAAAtC,GAAA;MAAAL,KAAA,EAMA,SAAA6C,IAAIxC,GAAG,EAAEL,KAAK,EAAE;QACd,OAAOiB,OAAO,CAACY,KAAK,IAAAN,MAAA,CAAIP,IAAI,aAAU,CAAC6B,GAAG,CAAC5B,OAAO,CAACc,YAAY,EAAE,EAAE1B,GAAG,EAAEN,SAAS,CAACC,KAAK,CAAC,CAAC;MAC3F;;MAEA;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;IAPI;MAAAK,GAAA;MAAAL,KAAA,EAQA,SAAA8C,QAAQzC,GAAG,EAAE;QACXY,OAAO,CAAC8B,MAAM,CAACC,KAAK,mBAAAzB,MAAA,CACAN,OAAO,CAACc,YAAY,EAAE,8BAAAR,MAAA,CAA4BlB,GAAG,OACxE;QACD,IAAMmC,KAAK,GAAG5C,MAAM,CAAC2C,GAAG,CAAC,IAAI,CAAC,CAACA,GAAG,CAAClC,GAAG,CAAC;QAEvC,IAAImC,KAAK,EAAE;UACTvB,OAAO,CAAC8B,MAAM,CAACC,KAAK,mBAAAzB,MAAA,CACAN,OAAO,CAACc,YAAY,EAAE,yBAAAR,MAAA,CAAuBlB,GAAG,OACnE;UAED,OAAOmC,KAAK,CAACS,OAAO;QACtB;QAEAhC,OAAO,CAAC8B,MAAM,CAACC,KAAK,mBAAAzB,MAAA,CAAmBN,OAAO,CAACc,YAAY,EAAE,kBAAAR,MAAA,CAAgBlB,GAAG,OAAK;QAErF,OAAO,IAAI,CAAC6C,SAAS,CAAC7C,GAAG,CAAC;MAC5B;IAAC;MAAAA,GAAA;MAAAL,KAAA,EAED,SAAAkD,UAUU7C,GAAG,EAAE;QACb,IAAMmC,KAAK,GAAG,IAAIC,aAAK,EAAE;QAEzB7C,MAAM,CAAC2C,GAAG,CAAC,IAAI,CAAC,CAACd,GAAG,CAACpB,GAAG,EAAEmC,KAAK,CAAC;;QAEhC;QACA;QACAvB,OAAO,CAACY,KAAK,IAAAN,MAAA,CAAIP,IAAI,aAAU,CAC5BuB,GAAG,CAACtB,OAAO,CAACc,YAAY,EAAE,EAAE1B,GAAG,CAAC,CAChCqC,IAAI,CAAC,UAAC1C,KAAK,EAAK;UACfiB,OAAO,CAAC8B,MAAM,CAACC,KAAK,mBAAAzB,MAAA,CACAN,OAAO,CAACc,YAAY,EAAE,cAAAR,MAAA,CAAYlB,GAAG,sBACxD;UACD,IAAIA,GAAG,KAAK,GAAG,EAAE;YACfY,OAAO,CAACkC,MAAM,CAAC1B,GAAG,CAACzB,KAAK,CAAC;UAC3B,CAAC,MAAM,IAAI,IAAAoD,QAAA,CAAAtD,OAAA,EAAOmB,OAAO,CAACZ,GAAG,CAAC,EAAE,SAAS,CAAC,EAAE;YAC1CY,OAAO,CAACZ,GAAG,CAAC,CAACoB,GAAG,CAACzB,KAAK,CAAC;UACzB,CAAC,MAAM;YACLiB,OAAO,CAACQ,GAAG,CAACpB,GAAG,EAAEL,KAAK,CAAC;UACzB;UACAiB,OAAO,CAAC8B,MAAM,CAACC,KAAK,mBAAAzB,MAAA,CACAN,OAAO,CAACc,YAAY,EAAE,cAAAR,MAAA,CAAYlB,GAAG,sBACxD;UACDmC,KAAK,CAACI,OAAO,EAAE;UACf3B,OAAO,CAAC8B,MAAM,CAACC,KAAK,mBAAAzB,MAAA,CAAmBN,OAAO,CAACc,YAAY,EAAE,iBAAAR,MAAA,CAAelB,GAAG,OAAK;QACtF,CAAC,CAAC,CACDgD,KAAK,CAAC,UAACC,MAAM,EAAK;UACjB;UACA;UACA;UACA,IACEA,MAAM,YAAYC,qBAAa,IAC9BC,OAAO,CAACC,GAAG,CAACC,QAAQ,KAAK,YAAY,IACpCJ,MAAM,CAACK,QAAQ,EAAE,CAACC,QAAQ,CAAC,mBAAmB,CAAE,EAClD;YACA3C,OAAO,CAAC8B,MAAM,CAACC,KAAK,mBAAAzB,MAAA,CACAN,OAAO,CAACc,YAAY,EAAE,sBAAAR,MAAA,CAAoBlB,GAAG,mBAChE;YAED,OAAOmC,KAAK,CAACI,OAAO,EAAE;UACxB;UACA3B,OAAO,CAAC8B,MAAM,CAACc,IAAI,mBAAAtC,MAAA,CACCN,OAAO,CAACc,YAAY,EAAE,yBAAAR,MAAA,CAAuBlB,GAAG,QAClEiD,MAAM,CACP;UAED,OAAOd,KAAK,CAACsB,MAAM,CAACR,MAAM,CAAC;QAC7B,CAAC,CAAC;QAEJ,OAAOd,KAAK,CAACS,OAAO;MACtB;IAAC;IAAA,OAAA7B,kBAAA;EAAA,UAAA2C,0BAAA,CAAAjE,OAAA,EAAAqB,MAAA,CAAA6C,SAAA,gBAAA9C,IAAA,OAAA+C,yBAAA,CAAAnE,OAAA,EAAAqB,MAAA,CAAA6C,SAAA,gBAAA7C,MAAA,CAAA6C,SAAA,IAAA7C,MAAA;EAGH,OAAO,IAAIC,kBAAkB,EAAE;AACjC"}