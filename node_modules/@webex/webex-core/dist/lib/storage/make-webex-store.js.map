{"version":3,"names":["_ampersandEvents","_interopRequireDefault","require","_common","bindings","_weakMap","default","makeWebexStore","type","webex","_dec","_class","WebexStore","oneFlight","keyFactory","namespace","_classCallCheck2","logger","debug","concat","set","_map","_createClass2","key","get","config","storage","value","clear","promises","forEach","binding","push","_promise","all","del","_getBinding","then","put","serialize","_this","resolve","adapter","bind","_binding","_applyDecoratedDescriptor2","prototype","_getOwnPropertyDescriptor","_assign","Events"],"sources":["make-webex-store.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport Events from 'ampersand-events';\nimport {oneFlight} from '@webex/common';\n\nconst bindings = new WeakMap();\n\n/**\n * Makes a WebexStore for the specified type bound to the specified webex instance\n * @param {string} type\n * @param {ProxyWebex} webex\n * @private\n * @returns {WebexStore}\n */\nexport default function makeWebexStore(type, webex) {\n  /**\n   * Lazy Key-Value Store Interface\n   */\n  class WebexStore {\n    /**\n     * @param {Object} attrs\n     * @param {Object} options\n     * @returns {Store}\n     */\n    constructor() {\n      webex.logger.debug(`webex-store: constructing ${type}Storage`);\n      bindings.set(this, new Map());\n    }\n\n    /**\n     * Provides easy access to the storage adapter identified in config.\n     * @returns {Object}\n     */\n    get adapter() {\n      return webex.config.storage[`${type}Adapter`];\n    }\n\n    /**\n     * @returns {WeakMap}\n     */\n    get bindings() {\n      return bindings.get(this);\n    }\n\n    /**\n     * Clears the store\n     * @returns {Promise}\n     */\n    clear() {\n      const promises = [];\n\n      this.bindings.forEach((binding) => {\n        promises.push(binding.clear());\n      });\n\n      return Promise.all(promises);\n    }\n\n    /**\n     * Deletes the specified key from the store\n     * @param {string} namespace\n     * @param {string} key\n     * @returns {[type]}\n     */\n    del(namespace, key) {\n      webex.logger.debug(`webex-store: removing ${namespace}:${key}`);\n\n      return this._getBinding(namespace).then((binding) => binding.del(key));\n    }\n\n    /**\n     * Retrieves the value specified by key from the store. Rejects with\n     * NotFoundError if no value can be found\n     * @param {string} namespace\n     * @param {string} key\n     * @returns {Promise}\n     */\n    get(namespace, key) {\n      webex.logger.debug(`webex-store: retrieving ${namespace}:${key}`);\n\n      return this._getBinding(namespace).then((binding) => binding.get(key));\n    }\n\n    /**\n     * Writes a value to the store. Deletes the specified key from the store\n     * if passed `undefined`\n     * @param {string} namespace\n     * @param {string} key\n     * @param {any} value\n     * @returns {Promise} Resolves with value (to simplify write-through caching)\n     */\n    put(namespace, key, value) {\n      if (typeof value === 'undefined') {\n        return this.del(namespace, key);\n      }\n      webex.logger.debug(`webex-store: setting ${namespace}:${key}`);\n\n      return this._getBinding(namespace)\n        .then((binding) => binding.put(key, value.serialize ? value.serialize() : value))\n        .then(() => value);\n    }\n\n    @oneFlight({keyFactory: (namespace) => namespace})\n    /**\n     * Creates an interface bound to the specified namespace\n     * @param {string} namespace\n     * @private\n     * @returns {Promise}\n     */\n    // suppress doc warning because decorators confuse eslint\n    // eslint-disable-next-line require-jsdoc\n    _getBinding(namespace) {\n      return new Promise((resolve) => {\n        webex.logger.debug(`storage: getting binding for \\`${namespace}\\``);\n        const binding = this.bindings.get(namespace);\n\n        if (binding) {\n          webex.logger.debug(`storage: found binding for \\`${namespace}\\``);\n\n          return resolve(binding);\n        }\n\n        return resolve(\n          this.adapter.bind(namespace, {logger: webex.logger}).then((_binding) => {\n            webex.logger.debug(`storage: made binding for \\`${namespace}\\``);\n            this.bindings.set(namespace, _binding);\n\n            return _binding;\n          })\n        );\n      });\n    }\n  }\n\n  Object.assign(WebexStore.prototype, Events);\n\n  return new WebexStore();\n}\n"],"mappings":"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"}