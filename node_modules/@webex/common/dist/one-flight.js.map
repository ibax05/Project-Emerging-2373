{"version":3,"names":["_templateContainer","_interopRequireDefault","require","W","_weakMap","default","M","_map","WeakMappedMappedMap","make","flights","oneFlight","_len","arguments","length","params","Array","_key","_apply","oneFlightDecorator","options","cacheFailures","cacheSuccesses","keyFactory","target","prop","descriptor","key","value","_wrap2","oneFlightExecutor","fn","_this","innerKey","_len2","args","_key2","concat","apply","flight","get","catch","reason","delete","_promise","reject","then","result","set","_typeof2","prototype"],"sources":["one-flight.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {wrap} from 'lodash';\n\nimport make from './template-container';\n\n// Alias Map and WeakMap to get around a babel compiler bug\nconst W = WeakMap;\nconst M = Map;\nconst WeakMappedMappedMap = make(W, M, M);\n\nconst flights = new WeakMappedMappedMap();\n\n/**\n * @memberof Util\n * @param {Object} options\n * @param {Function} options.keyFactory\n * @param {boolean} options.cacheFailures\n * @param {boolean} options.cacheSuccesses\n * @returns {Function}\n */\nexport default function oneFlight(...params) {\n  if (params.length === 3) {\n    return Reflect.apply(oneFlightDecorator, null, params);\n  }\n\n  const options = params[0] || {};\n\n  const {cacheFailures, cacheSuccesses, keyFactory} = options;\n\n  return oneFlightDecorator;\n\n  /**\n   * @param {Object} target\n   * @param {string} prop\n   * @param {Object} descriptor\n   * @private\n   * @returns {Object}\n   */\n  function oneFlightDecorator(target, prop, descriptor) {\n    const key = prop;\n\n    descriptor.value = wrap(descriptor.value, function oneFlightExecutor(fn, ...args) {\n      let innerKey = key;\n\n      if (keyFactory) {\n        innerKey = `${innerKey}_${keyFactory(...args)}`;\n      }\n\n      /* eslint no-invalid-this: [0] */\n      let flight = flights.get(this, target, innerKey);\n\n      if (flight) {\n        return flight;\n      }\n\n      flight = Reflect.apply(fn, this, args);\n      if (!cacheFailures && flight && flight.catch) {\n        flight = flight.catch((reason) => {\n          flights.delete(this, target, innerKey);\n\n          return Promise.reject(reason);\n        });\n      }\n\n      if (!cacheSuccesses && flight && flight.then) {\n        flight = flight.then((result) => {\n          flights.delete(this, target, innerKey);\n\n          return result;\n        });\n      }\n\n      flights.set(this, target, innerKey, flight);\n\n      return flight;\n    });\n\n    // This *should* make decorators compatible with AmpersandState class\n    // definitions\n    if (typeof target === 'object' && !target.prototype) {\n      target[prop] = descriptor.value;\n    }\n\n    return descriptor;\n  }\n}\n"],"mappings":"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"}