{"version":3,"names":["_events","require","_backoff","_interopRequireDefault","ownKeys","object","enumerableOnly","keys","_Object$keys","_Object$getOwnPropertySymbols","symbols","filter","sym","_Object$getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","Object","forEach","key","_defineProperty2","default","_Object$getOwnPropertyDescriptors","_Object$defineProperties","_Object$defineProperty","retry","_len","params","Array","_key","options","_defaults2","backoff","delay","maxAttempts","strategyOptions","initialDelay","maxDelay","_apply","retryDecorator","prop","descriptor","value","_wrap2","retryExecutor","fn","_this","_len2","args","_key2","emitter","EventEmitter","promise","_promise","resolve","reject","call","cb","innerPromise","_isFunction2","on","emit","bind","then","res","catch","reason","Error","err","setStrategy","ExponentialStrategy","failAfter","start","callback","_typeof2","prototype"],"sources":["retry.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {EventEmitter} from 'events';\n\nimport {defaults, isFunction, wrap} from 'lodash';\nimport backoff from 'backoff';\n\n/* eslint max-nested-callbacks: [0] */\n\n/**\n * Makes a promise-returning method retryable according to the specified backoff\n * pattern\n * @param {Object} options\n * @param {boolean} options.backoff\n * @param {number} options.delay\n * @param {number} options.initialDelay\n * @param {number} options.maxAttempts\n * @param {number} options.maxDelay\n *\n * @returns {Function}\n */\nexport default function retry(...params) {\n  let options = params[0] || {};\n\n  options = {...options};\n  defaults(options, {\n    backoff: true,\n    delay: 1,\n    maxAttempts: 3,\n  });\n\n  let strategyOptions;\n\n  if (options.backoff) {\n    strategyOptions = {\n      initialDelay: options.delay,\n      maxDelay: options.maxDelay,\n    };\n  } else {\n    strategyOptions = {\n      initialDelay: 1,\n      maxDelay: 1,\n    };\n  }\n\n  if (params.length === 3) {\n    return Reflect.apply(retryDecorator, null, params);\n  }\n\n  return retryDecorator;\n\n  /**\n   * @param {Object} target\n   * @param {string} prop\n   * @param {Object} descriptor\n   * @private\n   * @returns {Object}\n   */\n  function retryDecorator(target, prop, descriptor) {\n    descriptor.value = wrap(descriptor.value, function retryExecutor(fn, ...args) {\n      const emitter = new EventEmitter();\n      const promise = new Promise((resolve, reject) => {\n        // backoff.call is not Function.prototype.call; it's an unfortunate naming\n        // collision.\n        /* eslint prefer-reflect: [0] */\n        const call = backoff.call(\n          (cb) => {\n            /* eslint no-invalid-this: [0] */\n            const innerPromise = Reflect.apply(fn, this, args);\n\n            if (isFunction(innerPromise.on)) {\n              innerPromise.on('progress', emitter.emit.bind(emitter, 'progress'));\n              innerPromise.on('upload-progress', emitter.emit.bind(emitter, 'upload-progress'));\n              innerPromise.on('download-progress', emitter.emit.bind(emitter, 'download-progress'));\n            }\n\n            return innerPromise\n              .then((res) => {\n                cb(null, res);\n              })\n              .catch((reason) => {\n                if (!reason) {\n                  reason = new Error('retryable method failed without providing an error object');\n                }\n                cb(reason);\n              });\n          },\n          (err, res) => {\n            if (err) {\n              return reject(err);\n            }\n\n            return resolve(res);\n          }\n        );\n\n        call.setStrategy(new backoff.ExponentialStrategy(strategyOptions));\n        if (options.maxAttempts) {\n          call.failAfter(options.maxAttempts - 1);\n        }\n\n        call.start();\n      });\n\n      promise.on = function on(key, callback) {\n        emitter.on(key, callback);\n\n        return promise;\n      };\n\n      return promise;\n    });\n\n    // This *should* make decorators compatible with AmpersandState class\n    // definitions\n    if (typeof target === 'object' && !target.prototype) {\n      target[prop] = descriptor.value;\n    }\n\n    return descriptor;\n  }\n}\n"],"mappings":"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"}