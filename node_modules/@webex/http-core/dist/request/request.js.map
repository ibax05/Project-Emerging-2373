{"version":3,"names":["_request2","_interopRequireDefault","require","_safeBuffer","_common","_detect","_progressEvent","prepareOptions","options","responseType","encoding","withCredentials","jar","isBuffer","body","detect","then","type","headers","_promise","default","resolve","doRequest","logger","r","request","error","response","warn","Buffer","from","statusCode","method","url","on","total","_parseInt2","loaded","data","length","download","emit","ProgressEvent","_request"],"sources":["request.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport request from 'request';\nimport {Buffer} from 'safe-buffer';\nimport {isBuffer} from '@webex/common';\n\nimport detect from '../lib/detect';\nimport ProgressEvent from '../progress-event';\n\n/**\n * @param {Object} options\n * @private\n * @returns {Promise}\n */\nfunction prepareOptions(options) {\n  if (options.responseType === 'buffer' || options.responseType === 'blob') {\n    options.encoding = null;\n  }\n\n  if (options.withCredentials) {\n    options.jar = true;\n  }\n\n  if (isBuffer(options.body)) {\n    return detect(options.body).then((type) => {\n      options.headers['content-type'] = type;\n\n      return options;\n    });\n  }\n\n  return Promise.resolve(options);\n}\n\n/**\n * @param {Object} options\n * @private\n * @returns {Promise}\n */\nfunction doRequest(options) {\n  return new Promise((resolve) => {\n    const {logger} = options;\n\n    const r = request(options, (error, response) => {\n      if (error) {\n        logger.warn(error);\n      }\n\n      if (response) {\n        response.options = options;\n\n        // I'm not sure why this line is necessary. request seems to be creating\n        // buffers that aren't Buffers.\n        if (\n          options.responseType === 'buffer' &&\n          response.body.type === 'Buffer' &&\n          !isBuffer(response.body)\n        ) {\n          response.body = Buffer.from(response.body);\n        }\n\n        if (isBuffer(response.body) && !response.body.type) {\n          resolve(\n            detect(response.body).then((type) => {\n              response.body.type = type;\n\n              return response;\n            })\n          );\n\n          return;\n        }\n\n        resolve(response);\n      } else {\n        // Make a network error behave like a browser network error.\n        resolve({\n          statusCode: 0,\n          options,\n          headers: options.headers,\n          method: options.method,\n          url: options.url,\n          body: error,\n        });\n      }\n    });\n\n    r.on('response', (response) => {\n      const total = parseInt(response.headers['content-length'], 10);\n      let loaded = 0;\n\n      response.on('data', (data) => {\n        loaded += data.length;\n        options.download.emit('progress', new ProgressEvent(loaded, total));\n      });\n    });\n  });\n}\n\n/**\n * @name request\n * @param {Object} options\n * @returns {Promise}\n */\nexport default function _request(options) {\n  return prepareOptions(options).then(doRequest);\n}\n"],"mappings":"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"}